<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Semakan Pesanan - PipahCookies</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Outfit:wght@500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root {
      --primary: #A67734; --primary-dark: #8B5E26; --bg: #FAF9F6;
      --surface: #FFFFFF; --text-main: #2D241E; --text-muted: #8A817C;
      --border: #EAE5E0; --success: #25D366;
  }
  
  body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background: var(--bg); color: var(--text-main); 
      margin: 0; padding: 20px; min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
  }

  /* Invoice Card */
  .invoice-card {
      background: var(--surface);
      width: 100%; max-width: 500px;
      border-radius: 24px;
      padding: 0;
      box-shadow: 0 10px 30px -5px rgba(166, 119, 52, 0.1);
      overflow: hidden;
      position: relative;
      margin-bottom: 20px;
  }
  
  /* Decorative Top */
  .card-top {
      height: 12px;
      background: repeating-linear-gradient(45deg, var(--primary), var(--primary) 10px, #FAD961 10px, #FAD961 20px);
  }

  .header { text-align: center; padding: 30px 20px 20px 20px; border-bottom: 1px dashed var(--border); }
  .brand { font-family: 'Outfit', sans-serif; font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
  .status { display: inline-block; padding: 4px 12px; background: #FFF0DC; color: var(--primary-dark); border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

  .content { padding: 25px; }
  
  .info-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 13px; }
  .label { color: var(--text-muted); }
  .value { font-weight: 600; text-align: right; }

  .divider { height: 1px; background: var(--border); margin: 15px 0; }

  /* Item List */
  .item-list { margin-bottom: 20px; }
  .item { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .item-name { font-weight: 600; font-size: 14px; color: var(--text-main); flex: 1; padding-right: 10px; }
  .item-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .item-price { font-weight: 700; font-size: 14px; }

  /* Totals */
  .total-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px; color: var(--text-muted); }
  .grand-total { display: flex; justify-content: space-between; font-size: 18px; font-weight: 700; color: var(--primary); margin-top: 15px; padding-top: 15px; border-top: 2px dashed var(--border); }

  /* Action Buttons */
  .actions { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 12px; }
  
  .btn {
      width: 100%; padding: 16px; border: none; border-radius: 16px;
      font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 700;
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: 0.2s;
  }
  .btn:active { transform: scale(0.98); }

  .btn-whatsapp { background: var(--success); color: white; box-shadow: 0 8px 20px -5px rgba(37, 211, 102, 0.3); }
  .btn-download { background: var(--surface); color: var(--text-main); border: 1px solid var(--border); }
  .btn-back { background: transparent; color: var(--text-muted); font-size: 13px; margin-top: 10px; }

  /* PDF Print Hide */
  @media print { .actions, .card-top { display: none; } body { background: white; } .invoice-card { box-shadow: none; } }

</style>
</head>
<body>

  <div class="invoice-card" id="invoice-node">
      <div class="card-top"></div>
      <div class="header">
          <div class="brand">PipahCookies</div>
          <div class="status">Semakan Pesanan</div>
      </div>
      
      <div class="content">
          <div class="info-row">
              <span class="label">No. Pesanan</span>
              <span class="value" id="order-id">...</span>
          </div>
          <div class="info-row">
              <span class="label">Tarikh</span>
              <span class="value" id="order-date">...</span>
          </div>
          <div class="info-row">
              <span class="label">Pelanggan</span>
              <span class="value" id="order-name">...</span>
          </div>
          <div class="info-row" style="align-items:flex-start;">
              <span class="label">Alamat / Nota</span>
              <span class="value" id="order-addr" style="max-width: 180px;">...</span>
          </div>

          <div class="divider"></div>

          <div class="item-list" id="invoice-items">
              </div>

          <div class="divider"></div>

          <div class="total-row">
              <span>Subtotal</span>
              <span id="txt-subtotal">RM 0.00</span>
          </div>
          
          <div class="grand-total">
              <span>JUMLAH BESAR</span>
              <span id="txt-total">RM 0.00</span>
          </div>
      </div>
      
      <div style="background:#FDFBF7; padding:15px; text-align:center; border-top:1px solid var(--border);">
          <p style="margin:0; font-size:11px; color:var(--text-muted);">Terima kasih kerana menyokong bisnes kecil kami! ‚ù§Ô∏è</p>
      </div>
  </div>

  <div class="actions">
      <button class="btn btn-whatsapp" onclick="sendWhatsApp()">
          <i class="fab fa-whatsapp" style="font-size:18px;"></i> Sahkan & WhatsApp
      </button>
      
      <button class="btn btn-download" onclick="genPDF()">
          <i class="fas fa-file-download"></i> Simpan Resit (PDF)
      </button>
      
      <button class="btn btn-back" onclick="window.location.href='index.html'">
          &larr; Kembali atau ubah pesanan
      </button>
  </div>

<script>
  // LOAD DATA - FIX: Get items from orderInfo NOT pipah_cart (since cart is cleared)
  const orderInfo = JSON.parse(localStorage.getItem('pipah_order_info') || '{}');
  const cartItems = orderInfo.items || []; // This holds the cart data now

  // INIT
  document.addEventListener('DOMContentLoaded', () => {
      // Validate data
      if(!orderInfo.orderId || cartItems.length === 0) {
          alert("Tiada data pesanan atau sesi telah tamat.");
          window.location.href = 'index.html';
          return;
      }

      // Fill Info
      document.getElementById('order-id').innerText = orderInfo.orderId;
      document.getElementById('order-date').innerText = new Date(orderInfo.date).toLocaleDateString('ms-MY');
      document.getElementById('order-name').innerText = orderInfo.buyerName;
      document.getElementById('order-addr').innerText = orderInfo.buyerAddress;

      // Fill Items
      const list = document.getElementById('invoice-items');
      let subtotal = 0;
      
      cartItems.forEach(item => {
          // FIX: Use finalPrice (calculated tiered price) or fallback to original price
          const unitPrice = item.finalPrice || item.price;
          const totalItem = unitPrice * item.qty;
          subtotal += totalItem;
          
          list.innerHTML += `
            <div class="item">
                <div class="item-name">
                    ${item.name}
                    <div class="item-meta">RM ${unitPrice.toFixed(2)} x ${item.qty}</div>
                </div>
                <div class="item-price">RM ${totalItem.toFixed(2)}</div>
            </div>
          `;
      });

      document.getElementById('txt-subtotal').innerText = "RM " + subtotal.toFixed(2);
      document.getElementById('txt-total').innerText = "RM " + subtotal.toFixed(2);
  });

  // 1. WHATSAPP LOGIC
  function sendWhatsApp() {
      const phone = orderInfo.whatsappAdmin || '601121243407';
      let msg = `*PESANAN BARU PIPAH COOKIES* üç™\n`;
      msg += `ID: ${orderInfo.orderId}\n`;
      msg += `Nama: ${orderInfo.buyerName}\n`;
      msg += `Alamat/Nota: ${orderInfo.buyerAddress}\n\n`;
      msg += `*SENARAI BARANG:*\n`;
      
      let total = 0;
      cartItems.forEach(item => {
          const unitPrice = item.finalPrice || item.price;
          msg += `- ${item.name} (x${item.qty}) - RM ${(unitPrice * item.qty).toFixed(2)}\n`;
          total += unitPrice * item.qty;
      });
      
      msg += `\n*JUMLAH BESAR: RM ${total.toFixed(2)}*`;
      msg += `\n\nTerima kasih! Saya nak proceed payment.`;

      const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
  }

  // 2. PDF LOGIC
  function genPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: [80, 150] }); // Receipt size
      
      let y = 10;
      doc.setFontSize(14); doc.setFont("helvetica", "bold");
      doc.text("PipahCookies", 40, y, { align: "center" }); y += 6;
      
      doc.setFontSize(9); doc.setFont("helvetica", "normal");
      doc.text("Resit Pesanan", 40, y, { align: "center" }); y += 10;
      
      doc.text(`ID: ${orderInfo.orderId}`, 5, y); y += 5;
      doc.text(`Tkh: ${new Date().toLocaleDateString()}`, 5, y); y += 5;
      doc.text(`Nama: ${orderInfo.buyerName}`, 5, y); y += 8;
      
      doc.line(5, y, 75, y); y += 5;

      let total = 0;
      cartItems.forEach(item => {
          const unitPrice = item.finalPrice || item.price;
          doc.text(`${item.name} x${item.qty}`, 5, y);
          doc.text(`RM ${(unitPrice * item.qty).toFixed(2)}`, 75, y, { align: "right" });
          total += unitPrice * item.qty;
          y += 5;
      });

      y += 3;
      doc.line(5, y, 75, y); y += 5;
      
      doc.setFont("helvetica", "bold");
      doc.text("JUMLAH", 5, y);
      doc.text(`RM ${total.toFixed(2)}`, 75, y, { align: "right" });
      
      doc.save(`Resit_${orderInfo.orderId}.pdf`);
  }
</script>

</body>
</html>
